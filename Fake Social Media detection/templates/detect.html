{% extends "base.html" %}

{% block title %}Detect Fake Accounts{% endblock %}

{% block content %}
<div class="main-content">
    <h1 class="text-center mb-4">
        <i class="fas fa-search text-primary me-3"></i>
        Fake Account Detection
    </h1>
    <!-- How to Use Section -->
    <div class="alert alert-info mb-4">
        <strong>How to Use:</strong> Enter the account details below. The system will instantly analyze and tell you if the account is likely <span class="text-success fw-bold">REAL</span> or <span class="text-danger fw-bold">FAKE</span> with a confidence score. Hover <i class="fas fa-question-circle"></i> for tips!
    </div>
    <!-- Tips Section -->
    <div class="mb-4">
        <div class="row g-2">
            <div class="col-md-6">
                <div class="alert alert-light p-2 mb-1"><i class="fas fa-info-circle text-primary me-1"></i> <strong>Real Account:</strong> Has a profile picture, filled bio, balanced followers, regular posts, and real engagement.</div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-light p-2 mb-1"><i class="fas fa-exclamation-triangle text-danger me-1"></i> <strong>Fake Account:</strong> Suspicious username, no profile pic, few posts, follows many, low engagement, or generic info.</div>
            </div>
        </div>
    </div>
    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    {% if result %}
    <div class="card mb-4 animate__animated animate__fadeIn">
        <div class="card-body text-center">
            <h3>Detection Results</h3>
            <div class="row justify-content-center mb-3">
                <div class="col-md-6">
                    <div class="prediction-result {% if result.is_fake %}prediction-fake{% else %}prediction-real{% endif %} mb-3" style="font-size:1.5rem;">
                        {% if result.is_fake %}
                            <i class="fas fa-exclamation-triangle me-2 fa-2x"></i>FAKE ACCOUNT DETECTED
                        {% else %}
                            <i class="fas fa-check-circle me-2 fa-2x"></i>LIKELY REAL ACCOUNT
                        {% endif %}
                    </div>
                    <div class="mb-2">
                        <label class="fw-bold">Confidence:</label>
                        <div class="progress" style="height: 24px;">
                            <div class="progress-bar {% if result.is_fake %}bg-danger{% else %}bg-success{% endif %}" role="progressbar" style="width: {{ result.confidence * 100 }}%; font-size:1.1rem;" aria-valuenow="{{ result.confidence * 100 }}" aria-valuemin="0" aria-valuemax="100">{{ "%.1f"|format(result.confidence * 100) }}%</div>
                        </div>
                    </div>
                    <p>Fake Probability: {{ "%.1f"|format(result.probability * 100) }}%</p>
                    <div class="alert alert-secondary mt-3 text-start">
                        <strong>Why?</strong> {{ result.explanation if result.explanation else 'The system analyzed username, profile, activity, and engagement to make this decision.' }}
                    </div>
                    <button class="btn btn-danger mt-3" onclick="alert('Fake account reported! (Demo)')"><i class="fas fa-flag me-1"></i>Report Fake Account</button>
                </div>
                <div class="col-md-6 d-flex flex-column align-items-center justify-content-center">
                    <!-- Pie Chart for Real vs Fake Probability -->
                    <canvas id="probabilityPieChart" width="180" height="180"></canvas>
                    <!-- Bar Chart for Feature Contributions (if available) -->
                    {% if result.feature_contributions %}
                    <div class="w-100 mt-4">
                        <canvas id="featureBarChart" height="180"></canvas>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <script>
        // Pie chart for real vs fake probability
        const pieCtx = document.getElementById('probabilityPieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['Real', 'Fake'],
                datasets: [{
                    data: [{{ (1-result.probability)|round(2) }}, {{ result.probability|round(2) }}],
                    backgroundColor: ['#51cf66', '#ff6b6b'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
        {% if result.feature_contributions %}
        // Bar chart for feature contributions
        const barCtx = document.getElementById('featureBarChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: {{ result.feature_contributions.keys()|list|tojson }},
                datasets: [{
                    label: 'Feature Impact',
                    data: {{ result.feature_contributions.values()|list|tojson }},
                    backgroundColor: '#667eea',
                    borderColor: '#764ba2',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        {% endif %}
    </script>
    {% endif %}
    <div class="card">
        <div class="card-header">
            <h4>Account Information</h4>
        </div>
        <div class="card-body">
            <form method="POST" id="detectForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Username <i class="fas fa-question-circle text-info" title="e.g. john_doe, bot123, spam_acc"></i></label>
                            <input type="text" class="form-control" name="username" id="usernameInput" value="{{ form_data.username if form_data else '' }}" required placeholder="e.g. john_doe, bot123, spam_acc">
                            <span id="usernameWarning" class="badge bg-danger mt-2 d-none"><i class="fas fa-exclamation-triangle me-1"></i> Suspicious username pattern!</span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email/Phone Verified? <i class="fas fa-question-circle text-info" title="Has the account verified their email or phone?"></i></label>
                            <select class="form-control" name="verified_contact">
                                <option value="1" {% if form_data and form_data.verified_contact == '1' %}selected{% endif %}>Yes</option>
                                <option value="0" {% if form_data and form_data.verified_contact == '0' %}selected{% endif %}>No</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Bio/Description <i class="fas fa-question-circle text-info" title="Short description or bio shown on the profile."></i></label>
                            <textarea class="form-control" name="bio" id="bioInput" rows="2" placeholder="e.g. Social media enthusiast. Love tech & travel.">{{ form_data.bio if form_data else '' }}</textarea>
                            <span id="bioWarning" class="badge bg-danger mt-2 d-none"><i class="fas fa-exclamation-triangle me-1"></i> Suspicious or spammy keywords detected!</span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Account Age (days) <i class="fas fa-question-circle text-info" title="How many days since the account was created?"></i></label>
                            <input type="number" class="form-control" name="account_age_days" value="{{ form_data.account_age_days if form_data else '' }}" required placeholder="e.g. 365">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Followers <i class="fas fa-question-circle text-info" title="Number of people following this account."></i></label>
                            <input type="number" class="form-control" name="followers" value="{{ form_data.followers if form_data else '' }}" required placeholder="e.g. 1000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Following <i class="fas fa-question-circle text-info" title="Number of people this account follows."></i></label>
                            <input type="number" class="form-control" name="following" value="{{ form_data.following if form_data else '' }}" required placeholder="e.g. 500">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Posts Count <i class="fas fa-question-circle text-info" title="Total number of posts by this account."></i></label>
                            <input type="number" class="form-control" name="posts_count" value="{{ form_data.posts_count if form_data else '' }}" required placeholder="e.g. 50">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Avg Likes <i class="fas fa-question-circle text-info" title="Average likes per post."></i></label>
                            <input type="number" step="0.1" class="form-control" name="avg_likes" value="{{ form_data.avg_likes if form_data else '' }}" required placeholder="e.g. 25.5">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Avg Comments <i class="fas fa-question-circle text-info" title="Average comments per post."></i></label>
                            <input type="number" step="0.1" class="form-control" name="avg_comments" value="{{ form_data.avg_comments if form_data else '' }}" required placeholder="e.g. 5.2">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Avg Shares <i class="fas fa-question-circle text-info" title="Average shares per post."></i></label>
                            <input type="number" step="0.1" class="form-control" name="avg_shares" value="{{ form_data.avg_shares if form_data else '' }}" required placeholder="e.g. 2.1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Has Profile Pic <i class="fas fa-question-circle text-info" title="Does the account have a profile picture?"></i></label>
                            <select class="form-control" name="has_profile_pic">
                                <option value="1" {% if form_data and form_data.has_profile_pic == '1' %}selected{% endif %}>Yes</option>
                                <option value="0" {% if form_data and form_data.has_profile_pic == '0' %}selected{% endif %}>No</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">Analyze Account</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Username pattern detection
        const usernameInput = document.getElementById('usernameInput');
        const usernameWarning = document.getElementById('usernameWarning');
        function checkUsernamePattern(username) {
            if (!username) return false;
            const suspicious = /(bot|spam|fake|test|\d{4,})/i;
            return suspicious.test(username);
        }
        usernameInput.addEventListener('input', function() {
            if (checkUsernamePattern(this.value)) {
                usernameWarning.classList.remove('d-none');
            } else {
                usernameWarning.classList.add('d-none');
            }
        });
        if (checkUsernamePattern(usernameInput.value)) {
            usernameWarning.classList.remove('d-none');
        }
        // Bio spam keyword detection
        const bioInput = document.getElementById('bioInput');
        const bioWarning = document.getElementById('bioWarning');
        function checkBioSpam(bio) {
            if (!bio) return false;
            const spammy = /(buy followers|crypto|giveaway|free|discount|click here|visit|earn money|work from home|adult|xxx|loan|bet|casino|bitcoin|forex|investment|porn|sex)/i;
            return spammy.test(bio);
        }
        bioInput.addEventListener('input', function() {
            if (checkBioSpam(this.value)) {
                bioWarning.classList.remove('d-none');
            } else {
                bioWarning.classList.add('d-none');
            }
        });
        if (checkBioSpam(bioInput.value)) {
            bioWarning.classList.remove('d-none');
        }
    </script>
</div>
{% endblock %} 